Enum facility_type {
  house
  sauna
  greenhouse
  woodshed
  garage
  cellar
  pool
  grill
}

Enum alert_state {
  open
  ack
  closed
}

Enum severity_level {
  info
  warning
  critical
}

Enum actuator_type {
  binary
  level
  setpoint
}

Enum command_status {
  queued
  sent
  success
  failed
}

Enum user_role {
  admin
  operator
  viewer
}

Table users {
  id          integer      [pk]
  username    varchar      [not null, unique]
  role        user_role    [not null, default: 'viewer']
}

Table units {
  id    integer     [pk]
  code  varchar(32) [not null, unique]
  title varchar(120) [not null]
}

Table facilities {
  id         integer        [pk]
  name       varchar(120)   [not null]
  type       facility_type  [not null]
  created_at timestamptz    [not null, default: `now()`]
}

Table sensors {
  id          integer       [pk]
  user_id     integer       [not null]
  facility_id integer       [not null]
  name        varchar(120)  [not null]
  unit_id     integer
  min_val     double
  max_val     double
  sampling_s  int           [not null, default: 10]
  created_at  timestamptz   [not null, default: `now()`]
  updated_at  timestamptz

  Indexes {
    (facility_id)
    (user_id)
    (unit_id)
    (name)
  }
}

Table readings {
  sensor_id int          [not null]
  ts        timestamptz  [not null]
  value     double       [not null]

  Primary key (sensor_id, ts)

  Indexes {
    (ts)
  }
}

Table actuators {
  id          int           [pk]
  sensor_id   int           [not null]
  name        varchar(120)  [not null]
  type        actuator_type [not null]
  range_min   double
  range_max   double
  step        double
  created_at  timestamptz   [not null, default: `now()`]
  updated_at  timestamptz

  Indexes {
    (sensor_id)
    (type)
  }
}

Table rules {
  id         int            [pk]
  user_id    int            [not null]
  name       varchar(160)   [not null]
  expr       text           [not null, note: 'Напр.: pm2_5 > 50']
  window_s   int            [not null, default: 0]
  severity   severity_level [not null, default: 'warning']
  enabled    boolean        [not null, default: true]
  created_at timestamptz    [not null, default: `now()`]
  updated_at timestamptz

  Indexes {
    (user_id)
    (enabled)
    (severity)
  }
}

Table rule_sensors{
  rule_id   int  [not null]
  sensor_id int  [not null]

  Primary key (rule_id, sensor_id)

  Indexes {
    (sensor_id)
  }
}

Table alerts {
  id          int            [pk]
  rule_id     int            [not null]
  sensor_id   int
  started_at  timestamptz    [not null]
  ended_at    timestamptz
  state       alert_state    [not null, default: 'open']
  message     text
  ack_by      int            // users.id
  ack_at      timestamptz

  Indexes {
    (rule_id)
    (sensor_id)
    (state)
    (started_at)
  }
}

Table commands {
  id           int            [pk]
  actuator_id  int            [not null]
  issued_by    int            // users.id
  issued_at    timestamptz    [not null, default: `now()`]
  command      varchar(32)    [not null, note: 'ON|OFF|SET (валидация бизнес-логикой)']
  status       command_status [not null, default: 'queued']
  completed_at timestamptz
  error        text

  Indexes {
    (actuator_id)
    (issued_at)
    (status)
  }
}

Table command_args {
  command_id int         [not null]
  name       varchar(64) [not null]
  value      text        [not null]

  Primary key (command_id, name)
}

Ref: command_args.command_id > commands.id [delete: cascade]


Ref: sensors.user_id       > users.id
Ref: sensors.facility_id   > facilities.id
Ref: sensors.unit_id       > units.id

Ref: actuators.sensor_id   > sensors.id

Ref: commands.actuator_id  > actuators.id
Ref: commands.issued_by    > users.id

Ref: readings.sensor_id    > sensors.id

Ref: rules.user_id         > users.id
Ref: rule_sensors.rule_id  > rules.id
Ref: rule_sensors.sensor_id> sensors.id

Ref: alerts.rule_id        > rules.id
Ref: alerts.sensor_id      > sensors.id
Ref: alerts.ack_by         > users.id